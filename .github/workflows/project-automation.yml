name: Project Automation

on:
  issues:
    types: [opened, reopened]
  pull_request:
    types: [opened, ready_for_review, closed]
  pull_request_target:
    types: [opened, ready_for_review, closed]

jobs:
  add-to-project:
    name: Add issue to project
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    steps:
      - name: Add issue to Smart Pocket Development project
        uses: actions/add-to-project@v0.5.0
        with:
          project-url: https://github.com/users/patterueldev/projects/5
          github-token: ${{ secrets.GITHUB_TOKEN }}

  update-status-in-progress:
    name: Update status to In Progress
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request' || github.event_name == 'pull_request_target') &&
      github.event.action == 'opened' &&
      github.event.pull_request.draft == false
    steps:
      - name: Update project status
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pr = context.payload.pull_request;
            
            // Extract issue number from PR title or branch
            const issueMatch = pr.head.ref.match(/#(\d+)/);
            if (!issueMatch) {
              console.log('No issue number found in branch name');
              return;
            }
            
            const issueNumber = issueMatch[1];
            console.log(`Found issue #${issueNumber} from branch ${pr.head.ref}`);
            
            // Get project details
            const projectNumber = 5;
            const projectId = 'PVT_kwDONYjAQ84A1Rcc'; // Smart Pocket Development project ID
            
            // Find the project item
            const query = `
              query($owner: String!, $repo: String!, $number: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $number) {
                    projectItems(first: 10) {
                      nodes {
                        id
                        project {
                          id
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            const result = await github.graphql(query, {
              owner,
              repo,
              number: parseInt(issueNumber)
            });
            
            const projectItem = result.repository.issue.projectItems.nodes.find(
              item => item.project.id === projectId
            );
            
            if (!projectItem) {
              console.log('Issue not found in project');
              return;
            }
            
            // Get status field ID
            const fieldQuery = `
              query($projectId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    field(name: "Status") {
                      ... on ProjectV2SingleSelectField {
                        id
                        options {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            const fieldResult = await github.graphql(fieldQuery, { projectId });
            const statusField = fieldResult.node.field;
            const inProgressOption = statusField.options.find(opt => opt.name === 'In Progress');
            
            if (!inProgressOption) {
              console.log('In Progress status not found');
              return;
            }
            
            // Update the status
            const updateMutation = `
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(
                  input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: { singleSelectOptionId: $optionId }
                  }
                ) {
                  projectV2Item {
                    id
                  }
                }
              }
            `;
            
            await github.graphql(updateMutation, {
              projectId,
              itemId: projectItem.id,
              fieldId: statusField.id,
              optionId: inProgressOption.id
            });
            
            console.log(`Updated issue #${issueNumber} to In Progress`);

  update-status-in-review:
    name: Update status to In Review
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request' || github.event_name == 'pull_request_target') &&
      github.event.action == 'ready_for_review'
    steps:
      - name: Update project status
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pr = context.payload.pull_request;
            
            const issueMatch = pr.head.ref.match(/#(\d+)/);
            if (!issueMatch) {
              console.log('No issue number found in branch name');
              return;
            }
            
            const issueNumber = issueMatch[1];
            const projectId = 'PVT_kwDONYjAQ84A1Rcc';
            
            const query = `
              query($owner: String!, $repo: String!, $number: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $number) {
                    projectItems(first: 10) {
                      nodes {
                        id
                        project {
                          id
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            const result = await github.graphql(query, {
              owner,
              repo,
              number: parseInt(issueNumber)
            });
            
            const projectItem = result.repository.issue.projectItems.nodes.find(
              item => item.project.id === projectId
            );
            
            if (!projectItem) return;
            
            const fieldQuery = `
              query($projectId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    field(name: "Status") {
                      ... on ProjectV2SingleSelectField {
                        id
                        options {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            const fieldResult = await github.graphql(fieldQuery, { projectId });
            const statusField = fieldResult.node.field;
            const inReviewOption = statusField.options.find(opt => opt.name === 'In Review');
            
            if (!inReviewOption) return;
            
            const updateMutation = `
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(
                  input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: { singleSelectOptionId: $optionId }
                  }
                ) {
                  projectV2Item {
                    id
                  }
                }
              }
            `;
            
            await github.graphql(updateMutation, {
              projectId,
              itemId: projectItem.id,
              fieldId: statusField.id,
              optionId: inReviewOption.id
            });
            
            console.log(`Updated issue #${issueNumber} to In Review`);

  update-status-qa-or-done:
    name: Update status on merge
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request' || github.event_name == 'pull_request_target') &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true
    steps:
      - name: Update project status
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pr = context.payload.pull_request;
            
            const issueMatch = pr.head.ref.match(/#(\d+)/);
            if (!issueMatch) {
              console.log('No issue number found in branch name');
              return;
            }
            
            const issueNumber = issueMatch[1];
            const projectId = 'PVT_kwDONYjAQ84A1Rcc';
            
            // Determine if this is a release PR
            const isReleaseBranch = pr.head.ref.startsWith('release/#');
            const targetStatus = isReleaseBranch ? 'Done' : 'QA/Testing';
            
            console.log(`Branch: ${pr.head.ref}, Target status: ${targetStatus}`);
            
            const query = `
              query($owner: String!, $repo: String!, $number: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $number) {
                    projectItems(first: 10) {
                      nodes {
                        id
                        project {
                          id
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            const result = await github.graphql(query, {
              owner,
              repo,
              number: parseInt(issueNumber)
            });
            
            const projectItem = result.repository.issue.projectItems.nodes.find(
              item => item.project.id === projectId
            );
            
            if (!projectItem) return;
            
            const fieldQuery = `
              query($projectId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    field(name: "Status") {
                      ... on ProjectV2SingleSelectField {
                        id
                        options {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            const fieldResult = await github.graphql(fieldQuery, { projectId });
            const statusField = fieldResult.node.field;
            const targetOption = statusField.options.find(opt => opt.name === targetStatus);
            
            if (!targetOption) return;
            
            const updateMutation = `
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(
                  input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: { singleSelectOptionId: $optionId }
                  }
                ) {
                  projectV2Item {
                    id
                  }
                }
              }
            `;
            
            await github.graphql(updateMutation, {
              projectId,
              itemId: projectItem.id,
              fieldId: statusField.id,
              optionId: targetOption.id
            });
            
            console.log(`Updated issue #${issueNumber} to ${targetStatus}`);
