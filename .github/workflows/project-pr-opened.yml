name: Update Project Status - In Progress

on:
  pull_request:
    types: [opened, reopened]

jobs:
  update-status:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Get project data
        id: project-data
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ADD_TO_PROJECT_PAT }}
          script: |
            const query = `query($owner:String!, $number:Int!) {
              repository(owner:$owner, name:"smart-pocket-js") {
                issue(number:$number) {
                  projectItems(first:10) {
                    nodes {
                      id
                      project {
                        id
                        title
                      }
                    }
                  }
                }
              }
            }`;
            
            const variables = {
              owner: context.repo.owner,
              number: context.issue.number
            };
            
            const result = await github.graphql(query, variables);
            const items = result.repository.issue.projectItems.nodes;
            
            if (items.length === 0) {
              console.log('Issue not linked to any project');
              return;
            }
            
            const projectItem = items.find(item => 
              item.project.title === 'Smart Pocket Development'
            );
            
            if (!projectItem) {
              console.log('Issue not in Smart Pocket Development project');
              return;
            }
            
            core.setOutput('item-id', projectItem.id);
            core.setOutput('project-id', projectItem.project.id);

      - name: Get Status field ID
        if: steps.project-data.outputs.item-id
        id: field-id
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ADD_TO_PROJECT_PAT }}
          script: |
            const query = `query($projectId:ID!) {
              node(id:$projectId) {
                ... on ProjectV2 {
                  fields(first:20) {
                    nodes {
                      ... on ProjectV2SingleSelectField {
                        id
                        name
                        options {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }
            }`;
            
            const variables = {
              projectId: '${{ steps.project-data.outputs.project-id }}'
            };
            
            const result = await github.graphql(query, variables);
            const fields = result.node.fields.nodes;
            const statusField = fields.find(f => f.name === 'Status');
            
            if (!statusField) {
              core.setFailed('Status field not found');
              return;
            }
            
            const inProgressOption = statusField.options.find(o => 
              o.name === 'In Progress'
            );
            
            if (!inProgressOption) {
              core.setFailed('In Progress option not found');
              return;
            }
            
            core.setOutput('field-id', statusField.id);
            core.setOutput('option-id', inProgressOption.id);

      - name: Update status to In Progress
        if: steps.field-id.outputs.field-id
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ADD_TO_PROJECT_PAT }}
          script: |
            const mutation = `mutation($projectId:ID!, $itemId:ID!, $fieldId:ID!, $optionId:String!) {
              updateProjectV2ItemFieldValue(input: {
                projectId: $projectId
                itemId: $itemId
                fieldId: $fieldId
                value: {singleSelectOptionId: $optionId}
              }) {
                projectV2Item {
                  id
                }
              }
            }`;
            
            const variables = {
              projectId: '${{ steps.project-data.outputs.project-id }}',
              itemId: '${{ steps.project-data.outputs.item-id }}',
              fieldId: '${{ steps.field-id.outputs.field-id }}',
              optionId: '${{ steps.field-id.outputs.option-id }}'
            };
            
            await github.graphql(mutation, variables);
            console.log('Status updated to In Progress');
