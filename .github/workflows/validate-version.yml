name: Validate Version Bump

on:
  pull_request:
    types: [opened, synchronize, labeled, unlabeled]

permissions:
  pull-requests: read
  contents: read

jobs:
  validate-no-conflicts:
    name: Check for Label Conflicts
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Check conflicting labels
        run: |
          LABELS='${{ toJson(github.event.pull_request.labels.*.name) }}'
          
          HAS_QA_MOBILE=false
          HAS_QA_SERVER=false
          HAS_PROD=false
          HAS_SKIP=false
          
          if echo "$LABELS" | grep -q '"qa-mobile"'; then
            HAS_QA_MOBILE=true
          fi
          
          if echo "$LABELS" | grep -q '"qa-server"'; then
            HAS_QA_SERVER=true
          fi
          
          if echo "$LABELS" | grep -q '"prod-release"'; then
            HAS_PROD=true
          fi
          
          if echo "$LABELS" | grep -q '"skip-build"'; then
            HAS_SKIP=true
          fi
          
          CONFLICTS=0
          
          # Check for QA + prod conflict
          if ([ "$HAS_QA_MOBILE" == "true" ] || [ "$HAS_QA_SERVER" == "true" ]) && [ "$HAS_PROD" == "true" ]; then
            echo "âŒ ERROR: Cannot mix QA labels (qa-mobile, qa-server) with prod-release"
            echo "   Choose either QA or production, not both"
            CONFLICTS=$((CONFLICTS + 1))
          fi
          
          # Check for skip-build + qa-mobile conflict
          if [ "$HAS_SKIP" == "true" ] && [ "$HAS_QA_MOBILE" == "true" ]; then
            echo "âŒ ERROR: Cannot have both 'skip-build' and 'qa-mobile' labels"
            CONFLICTS=$((CONFLICTS + 1))
          fi
          
          # Check for skip-build + qa-server conflict
          if [ "$HAS_SKIP" == "true" ] && [ "$HAS_QA_SERVER" == "true" ]; then
            echo "âŒ ERROR: Cannot have both 'skip-build' and 'qa-server' labels"
            CONFLICTS=$((CONFLICTS + 1))
          fi
          
          # Check for skip-build + prod-release conflict
          if [ "$HAS_SKIP" == "true" ] && [ "$HAS_PROD" == "true" ]; then
            echo "âŒ ERROR: Cannot have both 'skip-build' and 'prod-release' labels"
            CONFLICTS=$((CONFLICTS + 1))
          fi
          
          if [ $CONFLICTS -gt 0 ]; then
            echo ""
            echo "Please remove conflicting labels before merging."
            exit 1
          fi
          
          echo "âœ… No label conflicts detected"

  validate-qa-build:
    name: Validate QA Build Version
    if: contains(github.event.pull_request.labels.*.name, 'qa-mobile') || contains(github.event.pull_request.labels.*.name, 'qa-server')
    runs-on: ubuntu-latest
    needs: [validate-no-conflicts]
    
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: Get base branch versions
        id: base_version
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git checkout origin/${{ github.event.pull_request.base.ref }}
          
          # Extract versions from app.config.js using Node.js
          cat > extract-version.js << 'EOF'
          const config = require('./apps/mobile/app.config.js');
          const versionCode = config.expo.android?.versionCode || 0;
          const buildNumber = config.expo.ios?.buildNumber || '0';
          const version = config.expo.version || '0.0.0';
          console.log(`VERSION_CODE=${versionCode}`);
          console.log(`BUILD_NUMBER=${buildNumber}`);
          console.log(`VERSION=${version}`);
          EOF
          
          VERSIONS=$(node extract-version.js)
          BASE_VERSION_CODE=$(echo "$VERSIONS" | grep VERSION_CODE | cut -d'=' -f2)
          BASE_BUILD_NUMBER=$(echo "$VERSIONS" | grep BUILD_NUMBER | cut -d'=' -f2)
          BASE_VERSION=$(echo "$VERSIONS" | grep "^VERSION=" | cut -d'=' -f2)
          
          echo "Base versionCode: $BASE_VERSION_CODE"
          echo "Base buildNumber: $BASE_BUILD_NUMBER"
          echo "Base version: $BASE_VERSION"
          echo "version_code=$BASE_VERSION_CODE" >> $GITHUB_OUTPUT
          echo "build_number=$BASE_BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "version=$BASE_VERSION" >> $GITHUB_OUTPUT
      
      - name: Get PR branch versions
        id: pr_version
        run: |
          git checkout ${{ github.event.pull_request.head.sha }}
          
          # Extract versions from app.config.js
          cat > extract-version.js << 'EOF'
          const config = require('./apps/mobile/app.config.js');
          const versionCode = config.expo.android?.versionCode || 0;
          const buildNumber = config.expo.ios?.buildNumber || '0';
          const version = config.expo.version || '0.0.0';
          console.log(`VERSION_CODE=${versionCode}`);
          console.log(`BUILD_NUMBER=${buildNumber}`);
          console.log(`VERSION=${version}`);
          EOF
          
          VERSIONS=$(node extract-version.js)
          PR_VERSION_CODE=$(echo "$VERSIONS" | grep VERSION_CODE | cut -d'=' -f2)
          PR_BUILD_NUMBER=$(echo "$VERSIONS" | grep BUILD_NUMBER | cut -d'=' -f2)
          PR_VERSION=$(echo "$VERSIONS" | grep "^VERSION=" | cut -d'=' -f2)
          
          echo "PR versionCode: $PR_VERSION_CODE"
          echo "PR buildNumber: $PR_BUILD_NUMBER"
          echo "PR version: $PR_VERSION"
          echo "version_code=$PR_VERSION_CODE" >> $GITHUB_OUTPUT
          echo "build_number=$PR_BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "version=$PR_VERSION" >> $GITHUB_OUTPUT
      
      - name: Validate build number increments
        run: |
          BASE_CODE=${{ steps.base_version.outputs.version_code }}
          PR_CODE=${{ steps.pr_version.outputs.version_code }}
          BASE_BUILD=${{ steps.base_version.outputs.build_number }}
          PR_BUILD=${{ steps.pr_version.outputs.build_number }}
          BASE_VERSION=${{ steps.base_version.outputs.version }}
          PR_VERSION=${{ steps.pr_version.outputs.version }}
          
          ERRORS=0
          
          echo "ðŸ” Validating QA build requirements..."
          echo ""
          echo "android.versionCode: $BASE_CODE â†’ $PR_CODE"
          echo "ios.buildNumber:     $BASE_BUILD â†’ $PR_BUILD"
          echo "version:             $BASE_VERSION â†’ $PR_VERSION"
          echo ""
          
          # Check versionCode increment (+1 only)
          EXPECTED_CODE=$((BASE_CODE + 1))
          if [ "$PR_CODE" -ne "$EXPECTED_CODE" ]; then
            echo "âŒ ERROR: android.versionCode must increment by exactly 1"
            echo "   Expected: $EXPECTED_CODE, Got: $PR_CODE"
            echo ""
            echo "Please update apps/mobile/app.config.js:"
            echo "   android: { versionCode: $EXPECTED_CODE }"
            ERRORS=$((ERRORS + 1))
          else
            echo "âœ… versionCode incremented correctly: $BASE_CODE â†’ $PR_CODE"
          fi
          
          # Check buildNumber increment (+1 only)
          EXPECTED_BUILD=$((BASE_BUILD + 1))
          if [ "$PR_BUILD" -ne "$EXPECTED_BUILD" ]; then
            echo "âŒ ERROR: ios.buildNumber must increment by exactly 1"
            echo "   Expected: $EXPECTED_BUILD, Got: $PR_BUILD"
            echo ""
            echo "Please update apps/mobile/app.config.js:"
            echo "   ios: { buildNumber: '$EXPECTED_BUILD' }"
            ERRORS=$((ERRORS + 1))
          else
            echo "âœ… buildNumber incremented correctly: $BASE_BUILD â†’ $PR_BUILD"
          fi
          
          # Version can stay the same for QA builds
          if [ "$BASE_VERSION" != "$PR_VERSION" ]; then
            echo "âš ï¸  WARNING: version changed from $BASE_VERSION to $PR_VERSION"
            echo "   QA builds typically keep the same semantic version"
            echo "   Only build numbers should increment for QA"
          else
            echo "âœ… version unchanged (expected for QA builds)"
          fi
          
          echo ""
          if [ $ERRORS -gt 0 ]; then
            echo "âŒ QA build validation failed with $ERRORS error(s)"
            exit 1
          fi
          
          echo "âœ… QA build validation passed!"

  validate-prod-release:
    name: Validate Production Release Version
    if: contains(github.event.pull_request.labels.*.name, 'prod-release')
    runs-on: ubuntu-latest
    needs: [validate-no-conflicts]
    
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: Get base branch versions
        id: base_version
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git checkout origin/${{ github.event.pull_request.base.ref }}
          
          # Get root package.json version
          BASE_ROOT_VERSION=$(node -p "require('./package.json').version")
          
          # Extract mobile versions from app.config.js
          cat > extract-version.js << 'EOF'
          const config = require('./apps/mobile/app.config.js');
          const versionCode = config.expo.android?.versionCode || 0;
          const buildNumber = config.expo.ios?.buildNumber || '0';
          const version = config.expo.version || '0.0.0';
          console.log(`VERSION_CODE=${versionCode}`);
          console.log(`BUILD_NUMBER=${buildNumber}`);
          console.log(`VERSION=${version}`);
          EOF
          
          VERSIONS=$(node extract-version.js)
          BASE_VERSION_CODE=$(echo "$VERSIONS" | grep VERSION_CODE | cut -d'=' -f2)
          BASE_BUILD_NUMBER=$(echo "$VERSIONS" | grep BUILD_NUMBER | cut -d'=' -f2)
          BASE_MOBILE_VERSION=$(echo "$VERSIONS" | grep "^VERSION=" | cut -d'=' -f2)
          
          echo "Base root version:   $BASE_ROOT_VERSION"
          echo "Base mobile version: $BASE_MOBILE_VERSION"
          echo "Base versionCode:    $BASE_VERSION_CODE"
          echo "Base buildNumber:    $BASE_BUILD_NUMBER"
          
          echo "root_version=$BASE_ROOT_VERSION" >> $GITHUB_OUTPUT
          echo "mobile_version=$BASE_MOBILE_VERSION" >> $GITHUB_OUTPUT
          echo "version_code=$BASE_VERSION_CODE" >> $GITHUB_OUTPUT
          echo "build_number=$BASE_BUILD_NUMBER" >> $GITHUB_OUTPUT
      
      - name: Get PR branch versions
        id: pr_version
        run: |
          git checkout ${{ github.event.pull_request.head.sha }}
          
          # Get root package.json version
          PR_ROOT_VERSION=$(node -p "require('./package.json').version")
          
          # Extract mobile versions from app.config.js
          cat > extract-version.js << 'EOF'
          const config = require('./apps/mobile/app.config.js');
          const versionCode = config.expo.android?.versionCode || 0;
          const buildNumber = config.expo.ios?.buildNumber || '0';
          const version = config.expo.version || '0.0.0';
          console.log(`VERSION_CODE=${versionCode}`);
          console.log(`BUILD_NUMBER=${buildNumber}`);
          console.log(`VERSION=${version}`);
          EOF
          
          VERSIONS=$(node extract-version.js)
          PR_VERSION_CODE=$(echo "$VERSIONS" | grep VERSION_CODE | cut -d'=' -f2)
          PR_BUILD_NUMBER=$(echo "$VERSIONS" | grep BUILD_NUMBER | cut -d'=' -f2)
          PR_MOBILE_VERSION=$(echo "$VERSIONS" | grep "^VERSION=" | cut -d'=' -f2)
          
          echo "PR root version:   $PR_ROOT_VERSION"
          echo "PR mobile version: $PR_MOBILE_VERSION"
          echo "PR versionCode:    $PR_VERSION_CODE"
          echo "PR buildNumber:    $PR_BUILD_NUMBER"
          
          echo "root_version=$PR_ROOT_VERSION" >> $GITHUB_OUTPUT
          echo "mobile_version=$PR_MOBILE_VERSION" >> $GITHUB_OUTPUT
          echo "version_code=$PR_VERSION_CODE" >> $GITHUB_OUTPUT
          echo "build_number=$PR_BUILD_NUMBER" >> $GITHUB_OUTPUT
      
      - name: Validate version bumps
        run: |
          BASE_ROOT=${{ steps.base_version.outputs.root_version }}
          PR_ROOT=${{ steps.pr_version.outputs.root_version }}
          BASE_MOBILE=${{ steps.base_version.outputs.mobile_version }}
          PR_MOBILE=${{ steps.pr_version.outputs.mobile_version }}
          BASE_CODE=${{ steps.base_version.outputs.version_code }}
          PR_CODE=${{ steps.pr_version.outputs.version_code }}
          BASE_BUILD=${{ steps.base_version.outputs.build_number }}
          PR_BUILD=${{ steps.pr_version.outputs.build_number }}
          
          ERRORS=0
          
          echo "ðŸ” Validating production release requirements..."
          echo ""
          echo "Root version:        $BASE_ROOT â†’ $PR_ROOT"
          echo "Mobile version:      $BASE_MOBILE â†’ $PR_MOBILE"
          echo "android.versionCode: $BASE_CODE â†’ $PR_CODE"
          echo "ios.buildNumber:     $BASE_BUILD â†’ $PR_BUILD"
          echo ""
          
          # Check root semantic version change
          if [ "$BASE_ROOT" == "$PR_ROOT" ]; then
            echo "âŒ ERROR: Root package.json version must change for production release"
            echo "   Current: $BASE_ROOT"
            echo "   Suggestions:"
            echo "   - Feature release: $(echo $BASE_ROOT | awk -F. '{print $1"."$2+1".0"}')"
            echo "   - Hotfix/patch:    $(echo $BASE_ROOT | awk -F. '{print $1"."$2"."$3+1}')"
            ERRORS=$((ERRORS + 1))
          else
            echo "âœ… Root version changed: $BASE_ROOT â†’ $PR_ROOT"
          fi
          
          # Check versionCode increment (+1 only)
          EXPECTED_CODE=$((BASE_CODE + 1))
          if [ "$PR_CODE" -ne "$EXPECTED_CODE" ]; then
            echo "âŒ ERROR: android.versionCode must increment by exactly 1"
            echo "   Expected: $EXPECTED_CODE, Got: $PR_CODE"
            ERRORS=$((ERRORS + 1))
          else
            echo "âœ… versionCode incremented correctly: $BASE_CODE â†’ $PR_CODE"
          fi
          
          # Check buildNumber increment (+1 only)
          EXPECTED_BUILD=$((BASE_BUILD + 1))
          if [ "$PR_BUILD" -ne "$EXPECTED_BUILD" ]; then
            echo "âŒ ERROR: ios.buildNumber must increment by exactly 1"
            echo "   Expected: $EXPECTED_BUILD, Got: $PR_BUILD"
            ERRORS=$((ERRORS + 1))
          else
            echo "âœ… buildNumber incremented correctly: $BASE_BUILD â†’ $PR_BUILD"
          fi
          
          echo ""
          if [ $ERRORS -gt 0 ]; then
            echo "âŒ Production release validation failed with $ERRORS error(s)"
            echo ""
            echo "For production releases, update:"
            echo "1. Root package.json version (semantic version x.y.z)"
            echo "2. apps/mobile/app.config.js android.versionCode (+1)"
            echo "3. apps/mobile/app.config.js ios.buildNumber (+1)"
            exit 1
          fi
          
          echo "âœ… Production release validation passed!"

  validate-version-sync:
    name: Validate Version Sync
    if: contains(github.event.pull_request.labels.*.name, 'qa-mobile') || contains(github.event.pull_request.labels.*.name, 'qa-server') || contains(github.event.pull_request.labels.*.name, 'prod-release')
    runs-on: ubuntu-latest
    needs: [validate-no-conflicts, validate-qa-build, validate-prod-release]
    # Run even if previous validations were skipped (but not if they failed)
    
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: Check version synchronization
        run: |
          # Get root package.json version and buildNumber
          ROOT_VERSION=$(node -p "require('./package.json').version")
          ROOT_BUILD_NUMBER=$(node -p "require('./package.json').buildNumber")
          
          # Get server package.json version
          SERVER_VERSION=$(node -p "require('./apps/server/package.json').version")
          
          # Get mobile app.config.js version and build number
          cat > extract-version.js << 'EOF'
          const config = require('./apps/mobile/app.config.js');
          const versionCode = config.expo.android?.versionCode || 0;
          const buildNumber = config.expo.ios?.buildNumber || '0';
          const version = config.expo.version || '0.0.0';
          console.log(`VERSION=${version}`);
          console.log(`BUILD_NUMBER=${buildNumber}`);
          console.log(`VERSION_CODE=${versionCode}`);
          EOF
          
          VERSIONS=$(node extract-version.js)
          MOBILE_VERSION=$(echo "$VERSIONS" | grep "^VERSION=" | cut -d'=' -f2)
          MOBILE_BUILD_NUMBER=$(echo "$VERSIONS" | grep BUILD_NUMBER | cut -d'=' -f2)
          MOBILE_VERSION_CODE=$(echo "$VERSIONS" | grep VERSION_CODE | cut -d'=' -f2)
          
          echo "ðŸ” Checking version synchronization across all files..."
          echo ""
          echo "Root package.json:"
          echo "  version:      $ROOT_VERSION"
          echo "  buildNumber:  $ROOT_BUILD_NUMBER"
          echo ""
          echo "Server package.json:"
          echo "  version:      $SERVER_VERSION"
          echo ""
          echo "Mobile app.config.js:"
          echo "  version:      $MOBILE_VERSION"
          echo "  buildNumber:  $MOBILE_BUILD_NUMBER (iOS)"
          echo "  versionCode:  $MOBILE_VERSION_CODE (Android)"
          echo ""
          
          ERRORS=0
          
          # Check root vs mobile version
          if [ "$ROOT_VERSION" != "$MOBILE_VERSION" ]; then
            echo "âŒ ERROR: Version mismatch between root and mobile!"
            echo "   Root package.json version:    $ROOT_VERSION"
            echo "   Mobile app.config.js version: $MOBILE_VERSION"
            echo ""
            echo "Update apps/mobile/app.config.js:"
            echo "   const VERSION = '$ROOT_VERSION';"
            ERRORS=$((ERRORS + 1))
          else
            echo "âœ… Root and mobile versions match: $ROOT_VERSION"
          fi
          
          # Check root vs server version
          if [ "$ROOT_VERSION" != "$SERVER_VERSION" ]; then
            echo "âŒ ERROR: Version mismatch between root and server!"
            echo "   Root package.json version:   $ROOT_VERSION"
            echo "   Server package.json version: $SERVER_VERSION"
            echo ""
            echo "Update apps/server/package.json:"
            echo "   \"version\": \"$ROOT_VERSION\""
            ERRORS=$((ERRORS + 1))
          else
            echo "âœ… Root and server versions match: $ROOT_VERSION"
          fi
          
          # Check root buildNumber vs mobile buildNumber
          if [ "$ROOT_BUILD_NUMBER" != "$MOBILE_BUILD_NUMBER" ]; then
            echo "âŒ ERROR: Build number mismatch!"
            echo "   Root package.json buildNumber:     $ROOT_BUILD_NUMBER"
            echo "   Mobile app.config.js BUILD_NUMBER: $MOBILE_BUILD_NUMBER"
            echo ""
            echo "Update apps/mobile/app.config.js:"
            echo "   const BUILD_NUMBER = $ROOT_BUILD_NUMBER;"
            ERRORS=$((ERRORS + 1))
          else
            echo "âœ… Root and mobile build numbers match: $ROOT_BUILD_NUMBER"
          fi
          
          # Check mobile iOS buildNumber vs Android versionCode
          if [ "$MOBILE_BUILD_NUMBER" != "$MOBILE_VERSION_CODE" ]; then
            echo "âŒ ERROR: iOS buildNumber and Android versionCode don't match!"
            echo "   ios.buildNumber:     $MOBILE_BUILD_NUMBER"
            echo "   android.versionCode: $MOBILE_VERSION_CODE"
            echo ""
            echo "Both must use the same BUILD_NUMBER constant in app.config.js"
            ERRORS=$((ERRORS + 1))
          else
            echo "âœ… iOS and Android build numbers match: $MOBILE_BUILD_NUMBER"
          fi
          
          echo ""
          if [ $ERRORS -gt 0 ]; then
            echo "âŒ Version synchronization failed with $ERRORS error(s)"
            echo ""
            echo "Source of truth: Root package.json"
            echo "  version:     $ROOT_VERSION"
            echo "  buildNumber: $ROOT_BUILD_NUMBER"
            echo ""
            echo "All files must match these values."
            exit 1
          fi
          
          echo "âœ… All versions and build numbers are synchronized"

  validation-summary:
    name: Version Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-no-conflicts, validate-qa-build, validate-prod-release, validate-version-sync]
    if: always()
    
    steps:
      - name: Check validation results
        run: |
          echo "ðŸ” Validation Results:"
          echo "   Label Conflicts:    ${{ needs.validate-no-conflicts.result }}"
          echo "   QA Build:           ${{ needs.validate-qa-build.result }}"
          echo "   Production Release: ${{ needs.validate-prod-release.result }}"
          echo "   Version Sync:       ${{ needs.validate-version-sync.result }}"
          echo ""
          
          # Check for conflicts (this must always pass)
          if [ "${{ needs.validate-no-conflicts.result }}" == "failure" ]; then
            echo "âŒ Label conflicts detected"
            exit 1
          fi
          
          # If QA build validation ran and failed, block
          if [ "${{ needs.validate-qa-build.result }}" == "failure" ]; then
            echo "âŒ QA build validation failed"
            exit 1
          fi
          
          # If production release validation ran and failed, block
          if [ "${{ needs.validate-prod-release.result }}" == "failure" ]; then
            echo "âŒ Production release validation failed"
            exit 1
          fi
          
          # If version sync validation ran and failed, block
          if [ "${{ needs.validate-version-sync.result }}" == "failure" ]; then
            echo "âŒ Version sync validation failed"
            exit 1
          fi
          
          # All validations either passed or were skipped (no build labels)
          echo "âœ… All version validations passed"
