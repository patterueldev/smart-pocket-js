# Docker Compose for Smart Pocket QA (Homeserver)
# Purpose: Pull pre-built images from GitHub Container Registry for QA testing
# 
# Setup:
# 1. Copy this file to your homeserver
# 2. Create .env file with required variables (see .env.example below)
# 3. Run: docker compose -f docker-compose.homeserver-qa.yml up -d
#
# Images are pulled from: ghcr.io/patterueldev/smart-pocket-js/server:qa

services:
  postgres-qa:
    image: postgres:16-alpine
    container_name: smart-pocket-postgres-qa
    environment:
      POSTGRES_DB: smart_pocket_qa
      POSTGRES_USER: smart_pocket
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-secure_password}
    volumes:
      - postgres-qa-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"  # Different port to avoid conflicts
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U smart_pocket"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    networks:
      - smart-pocket-qa-network

  actual-budget-qa:
    image: docker.io/actualbudget/actual-server:latest
    container_name: smart-pocket-actual-qa
    ports:
      - "5007:5006"  # Different port to avoid conflicts
    volumes:
      - actual-qa-data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:5006', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - smart-pocket-qa-network

  smart-pocket-server-qa:
    # Pull pre-built image from GitHub Container Registry
    image: ghcr.io/patterueldev/smart-pocket-js/server:qa
    container_name: smart-pocket-server-qa
    pull_policy: always  # Always pull latest :qa image
    ports:
      - "3002:3001"  # Different port to avoid conflicts
    environment:
      NODE_ENV: production
      PORT: 3001
      DATABASE_URL: postgres://smart_pocket:${POSTGRES_PASSWORD:-secure_password}@postgres-qa:5432/smart_pocket_qa
      DATABASE_SSL: false
      ACTUAL_BUDGET_URL: http://actual-budget-qa:5006
      ACTUAL_BUDGET_PASSWORD: ${ACTUAL_BUDGET_PASSWORD:-}
      ACTUAL_BUDGET_SYNC_ID: ${ACTUAL_BUDGET_SYNC_ID:-}
      ACTUAL_BUDGET_ENABLED: ${ACTUAL_BUDGET_ENABLED:-true}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      API_KEY: ${API_KEY}
      JWT_SECRET: ${JWT_SECRET}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      GOOGLE_SHEETS_ENABLED: ${GOOGLE_SHEETS_ENABLED:-false}
      GOOGLE_SHEET_ID: ${GOOGLE_SHEET_ID:-}
      GOOGLE_SHEET_NAME: ${GOOGLE_SHEET_NAME:-Accounts}
      GOOGLE_CREDENTIALS_JSON_PATH: /data/keys/smart-pocket-server.json
      DEFAULT_CURRENCY: ${DEFAULT_CURRENCY:-USD}
    volumes:
      # Optional: Mount Google Sheets credentials if using that feature
      # Comment out or remove this line if you don't have the credentials file
      # - ./keys/smart-pocket-server.json:/data/keys/smart-pocket-server.json:ro
    depends_on:
      postgres-qa:
        condition: service_healthy
      actual-budget-qa:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    networks:
      - smart-pocket-qa-network

volumes:
  postgres-qa-data:
    name: smart-pocket-postgres-qa-data
  actual-qa-data:
    name: smart-pocket-actual-qa-data

networks:
  smart-pocket-qa-network:
    name: smart-pocket-qa-network
    driver: bridge
